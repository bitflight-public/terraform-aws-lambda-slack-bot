name: Validate

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

permissions:
  contents: read

jobs:
  validate-python:
    name: Validate Python Code
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Set up Python
        run: uv python install 3.12

      - name: Install dependencies
        run: uv sync --frozen

      - name: Check Python syntax
        run: |
          python -m py_compile lambda/*.py
          echo "✓ All Python files have valid syntax"

      - name: Lint with Ruff
        run: |
          uv run ruff check lambda/ --output-format=github
          echo "✓ Ruff linting passed"

      - name: Check formatting with Ruff
        run: |
          uv run ruff format --check lambda/
          echo "✓ Ruff formatting check passed"

      - name: Type check with mypy
        run: |
          uv run mypy lambda/
          echo "✓ Mypy type checking passed"

      - name: Type check with basedpyright
        run: |
          uv run basedpyright lambda/
          echo "✓ Basedpyright type checking passed"

  validate-terraform:
    name: Validate Terraform
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: v0.60.0

      - name: Terraform Format Check
        run: terraform fmt -check -recursive

      - name: Terraform Init
        run: terraform init -backend=false

      - name: Terraform Validate
        run: terraform validate

      - name: Initialize TFLint
        run: tflint --init

      - name: Run TFLint
        run: tflint --format compact

      - name: Report success
        run: echo "✓ Terraform configuration is valid and passes all linting checks"

  pre-commit:
    name: Pre-commit Hooks
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Set up Python
        run: uv python install 3.12

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: v0.60.0

      - name: Initialize TFLint
        run: tflint --init

      - name: Install terraform-docs
        run: |
          curl -sSLo ./terraform-docs.tar.gz https://terraform-docs.io/dl/v0.19.0/terraform-docs-v0.19.0-linux-amd64.tar.gz
          tar -xzf terraform-docs.tar.gz
          chmod +x terraform-docs
          sudo mv terraform-docs /usr/local/bin/
          rm terraform-docs.tar.gz

      - name: Install Python dependencies
        run: uv sync --frozen

      - name: Run prek hooks
        run: uv run prek run --all-files
